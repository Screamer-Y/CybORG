from ipaddress import IPv4Address

from CybORG.Shared import Observation
from CybORG.Simulator.Actions import Action
from CybORG.Simulator.Actions.ConcreteActions.Portscan import Portscan
from CybORG.Simulator.AbstractVulnerability import AbstractVulnerability
from CybORG.Simulator.Actions.ConcreteActions.IPDiscovered import IPDiscovered
from CybORG.Simulator.Actions.AbstractActions.DiscoverNetworkServices import DiscoverNetworkServices
from CybORG.Simulator.Actions.AbstractActions.ExploitRemoteService import ExploitRemoteService
from CybORG.Shared.ActionSpace import ActionSpace
from CybORG.Simulator.Host import Status


class ExploitLocalVulnerability(Action):
    """
    Abstract Action that allows an agent to exploit a LOCAL Abstract Vulnerability.
    Action succeed if the Abstract Vulnerability exist in host and meet the LOCAL priviledge requirement.
    """
    def __init__(self, session: int, agent: str, hostname:str, absvul: AbstractVulnerability):
        super().__init__()
        self.hostname = hostname
        self.absvul = absvul
        self.agent = agent
        self.session = session
        self.action_space = self.absvul.environment_controller.agent_interfaces['Red'].action_space

    def record_exploitation(self, obs):
        # Record the exploitation
        if obs.success:
            self.absvul.history[len(self.absvul.history)+1] = {'host':self.hostname, 'success':True}
        else:
            self.absvul.history[len(self.absvul.history)+1] = {'host':self.hostname, 'success':False}

    def execute(self, state) -> Observation:
        # check whether the host is running or reimaging
        if not state.hosts[self.hostname].status == Status.RUNNING:
            obs = Observation(success=False)
            self.record_exploitation(obs)
            return obs
        # check if the vulnerability exists in the host
        if self.absvul.hostname != self.hostname:
            obs = Observation(success=False)
            self.record_exploitation(obs)
            return obs
        # check if the vulnerability has already been exploited
        if self.absvul.exploited:
            obs = Observation(success=False)
            self.record_exploitation(obs)
            return obs
        # check if there are high privilege session
        sessions = [s for s in state.sessions[self.agent].values() if s.hostname == self.hostname]
        if len(sessions) == 0:
            # no valid session could be found on chosen host
            obs = Observation(success=False)
            self.record_exploitation(obs)
            return obs
        # find if any session are already SYSTEM or root
        flag = False
        for s in sessions:
            if s.username == 'root' or s.username == 'SYSTEM':
                flag = True
                break
        if not flag:
            obs = Observation(success=False)
            self.record_exploitation(obs)
            return obs

        # execute action based on outcome
        if self.absvul.outcome == AbstractVulnerability.Outcome.IP_DISCOVERED:
            sub_action = IPDiscovered(self.session, self.agent, self.hostname, self.absvul.target_host_id)
            obs = sub_action.execute(state)
            obs.add_system_info(hostname=self.absvul.target_host_id)
            self.record_exploitation(obs)
        elif self.absvul.outcome == AbstractVulnerability.Outcome.SERVICE_EXPLOITED:
            # if target_host unknown, Discovered its ip first.
            swapped_dict = {v: k for k, v in state.ip_addresses.items()}
            host_ip = swapped_dict[self.absvul.target_host_id]
            if not self.action_space.ip_address[host_ip]:
                sub_action = IPDiscovered(self.session, self.agent, self.hostname, self.absvul.target_host_id)
                obs = sub_action.execute(state)
            # Establish high priviledge on the host
            target_ip = swapped_dict[self.absvul.target_host_id]
            sub_action = DiscoverNetworkServices(self.session, self.agent, target_ip)
            obs = sub_action.execute(state)
            sub_action = ExploitRemoteService(target_ip, self.session, self.agent)
            obs = sub_action.execute(state)
            self.record_exploitation(obs)
        else:
            raise ValueError("Invalid Abstract Vulnerability Outcome.")
        self.absvul.exploited = True

        return obs

    def __str__(self):
        return f"{self.__class__.__name__} {self.hostname} {self.absvul.vulnerability_id}"

    def __eq__(self, other):
        if not isinstance(other, self.__class__):
            return False

        equality_tuple = (
                self.hostname == other.hostname,
                self.absvul == other.absvul,
                self.agent == other.agent,
                self.session == other.session,
                )

        return all(equality_tuple)
